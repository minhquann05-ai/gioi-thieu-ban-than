if(!text){ alert('Chưa có số nào để sao chép.'); return; }
      try{
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = 'Đã sao chép!';
        setTimeout(()=> copyBtn.textContent = 'Sao chép', 1200);
      }catch(e){
        output.select();
        document.execCommand('copy');
        copyBtn.textContent = 'Đã sao chép!';
        setTimeout(()=> copyBtn.textContent = 'Sao chép', 1200);
      }
    });

    clearBtn.addEventListener('click', ()=>{
      if(selected.size === 0) return;
      document.querySelectorAll('.cell.selected').forEach(c=> { c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); });
      selected.clear();
      countEl.textContent = '0';
      output.value = '';
      
      // Lưu lại trạng thái rỗng
      saveData();
    });

    // Hỗ trợ phím tắt
    let keyBuffer = '';
    let keyTimer = null;
    window.addEventListener('keydown', (e)=>{
      if(e.key >= '0' && e.key <= '9'){
        keyBuffer += e.key;
        if(keyTimer) clearTimeout(keyTimer);
        keyTimer = setTimeout(()=> { keyBuffer = ''; keyTimer = null; }, 700);
        if(keyBuffer.length === 2){
          const v = keyBuffer;
          const cell = Array.from(document.querySelectorAll('.cell')).find(c=> c.dataset.value === v);
          if(cell) { toggleCell(cell); }
          keyBuffer = '';
          if(keyTimer) { clearTimeout(keyTimer); keyTimer = null; }
        }
      }
    });

    // --- 3. HÀM KHÔI PHỤC DỮ LIỆU KHI LOAD LẠI TRANG ---
    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                const arr = JSON.parse(saved);
                arr.forEach(val => {
                    selected.add(val);
                    // Tìm ô tương ứng để tô màu
                    const cell = document.querySelector(`.cell[data-value="${val}"]`);
                    if(cell) {
                        cell.classList.add('selected');
                        cell.setAttribute('aria-pressed', 'true');
                    }
                });
                // Cập nhật số lượng
                countEl.textContent = selected.size;
                // Cập nhật ô text kết quả
                if (selected.size > 0) {
                    output.value = getSortedSelected().join(', ');
                }
            } catch (e) {
                console.error("Lỗi khi tải dữ liệu cũ:", e);
                localStorage.removeItem(STORAGE_KEY); // Xóa nếu dữ liệu lỗi
            }
        }
    }

    // Chạy hàm load ngay khi mở web
    loadData();

  </script>
</body>
</html>
